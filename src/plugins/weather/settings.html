<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<style>
    .settings-section {
        margin-top: 12px;
    }

    .section-title {
        font-weight: bold;
        margin: 6px 0;
        color: var(--text-primary);
    }
</style>

<div class="settings-section">
    <div class="section-title">Location</div>
    <div class="form-group">
        <span>Latitude </span>
        <input readonly type="text" id="latitude" name="latitude" class="form-input" />
    </div>
    <div class="form-group">
        <span>Longitude </span>
        <input readonly type="text" id="longitude" name="longitude" class="form-input" />
    </div>
    <button type="button" id="openMap" class="action-button compact">Select Location</button>
</div>

<div class="separator"></div>

<div class="settings-section">
    <div class="section-title">Provider & Units</div>
    <div class="form-group">
        <label for="weatherProvider" class="form-label">Weather Provider:</label>
        <select id="weatherProvider" name="weatherProvider" class="form-input" onchange="updateTitleOptions(this.value)">
            <option value="OpenMeteo">Open-Meteo</option>
            <option value="OpenWeatherMap">OpenWeatherMap</option>
        </select>
    </div>
    <div class="form-group">
        <label for="units" class="form-label">Units:</label>
        <select id="units" name="units" class="form-input">
            <option value="imperial">Imperial (°F)</option>
            <option value="metric">Metric (°C)</option>
            <option value="standard">Standard (K)</option>
        </select>
    </div>
</div>

<div class="settings-section" id="titleOptionWrapper">
    <div class="section-title">Title</div>
    <div class="form-group">
        <input type="radio" id="title-location" name="titleSelection" value="location">
        <label for="title-location">Location</label>

        <input type="radio" id="title-none" name="titleSelection" value="none">
        <label for="title-none">None</label>

        <input type="radio" id="title-custom" name="titleSelection" value="custom">
        <label for="title-custom">Custom</label>
        <input type="text" id="customTitle" name="customTitle" class="form-input" placeholder="Type something..." />
    </div>
</div>

<div class="settings-section">
    <div class="section-title">Display</div>
    <div class="form-group">
        <input type="checkbox" id="displayRefreshTime" name="displayRefreshTime" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Last Updated Time</span>
    </div>
    <div class="form-group">
        <input type="checkbox" id="displayMetricIcons" name="displayMetricIcons" onclick="this.value=this.checked ? 'true' : 'false';">
        <input type="hidden" name="displayMetricIcons" value="false">
        <span>Metric Icons</span>
    </div>
    <div class="form-group">
        <input type="checkbox" id="displayForecastIcons" name="displayForecastIcons" onclick="this.value=this.checked ? 'true' : 'false';">
        <input type="hidden" name="displayForecastIcons" value="false">
        <span>Forecast Icons</span>
    </div>
    <div class="form-group">
        <input type="checkbox" id="displayGraph" name="displayGraph" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Weather Graph</span>
    </div>
    <div class="form-group">
        <input type="checkbox" id="displayRain" name="displayRain" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Rain Amount</span>
    </div>
</div>

<div class="settings-section">
    <div class="section-title">Metrics</div>
    <div class="form-group">
        <input type="checkbox" id="displayMetrics" name="displayMetrics" onclick="this.value=this.checked ? 'true' : 'false'; toggleMetricOptions(this.checked);">
        <span>Metrics</span>
    </div>
    <div class="form-group">
        <input type="checkbox" id="displayMetricSunrise" name="displayMetricSunrise" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Sunrise</span>
    </div>
    <div class="form-group">
        <input type="checkbox" id="displayMetricSunset" name="displayMetricSunset" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Sunset</span>
    </div>
    <div class="form-group">
        <input type="checkbox" id="displayMetricWind" name="displayMetricWind" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Wind</span>
    </div>
    <div class="form-group">
        <input type="checkbox" id="displayMetricHumidity" name="displayMetricHumidity" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Humidity</span>
    </div>
    <div class="form-group">
        <input type="checkbox" id="displayMetricPressure" name="displayMetricPressure" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Pressure</span>
    </div>
    <div class="form-group">
        <input type="checkbox" id="displayMetricUvIndex" name="displayMetricUvIndex" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>UV Index</span>
    </div>
    <div class="form-group">
        <input type="checkbox" id="displayMetricVisibility" name="displayMetricVisibility" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Visibility</span>
    </div>
    <div class="form-group">
        <input type="checkbox" id="displayMetricAirQuality" name="displayMetricAirQuality" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Air Quality</span>
    </div>
</div>

<div class="settings-section">
    <div class="section-title">Forecast</div>
    <div class="form-group">
        <input type="checkbox" id="displayForecast" name="displayForecast" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Forecast</span>
        <select id="forecastDays" name="forecastDays" class="form-input">
            <option value=3>3</option>
            <option value=5>5</option>
            <option value=7>7</option>
        </select>
        <span>days</span>
    </div>
    <div class="form-group">
        <input type="checkbox" id="displayForecastPrecip" name="displayForecastPrecip" onclick="this.value=this.checked ? 'true' : 'false';">
        <input type="hidden" name="displayForecastPrecip" value="false">
        <span>Forecast Precipitation</span>
    </div>
    <div class="form-group">
        <input type="checkbox" id="moonPhase" name="moonPhase" onclick="this.value=this.checked ? 'true' : 'false';">
        <span>Moon Phase</span>
    </div>
</div>

<div class="settings-section">
    <div class="section-title">Time Zone</div>
    <div class="form-group">
        <label for="weatherTimeZone" class="form-label">Time Zone:</label>
        <select id="weatherTimeZone" name="weatherTimeZone" class="form-input">
            <option value="locationTimeZone">Use Location Time Zone</option>
            <option value="localTimeZone">Use Local Time Zone</option>
        </select>
    </div>
    <div class="form-group">
        <input type="checkbox" id="use24hTime" name="use24hTime" onclick="this.value=this.checked ? 'true' : 'false';">
        <input type="hidden" name="use24hTime" value="false">
        <span>Use 24-hour time</span>
    </div>
</div>

<div id="mapModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal('mapModal')">×</span>
        <h2 id="modalTitle">Select Location</h2>
        <div class="separator"></div>
        <div id="map" style="width: 100%; height: 200px; margin: 10px 0px;"></div>
        <button id="closeMap" class="action-button">Save</button>
    </div>
</div>

<script>

    function updateTitleOptions(provider) {
        const titleLocationRadio = document.getElementById('title-location');
        const titleLocationLabel = document.querySelector('label[for="title-location"]');
        const titleNoneRadio = document.getElementById('title-none');
        const titleNoneLabel = document.querySelector('label[for="title-none"]');
        const titleCustomRadio = document.getElementById('title-custom');
        const customTitleInput = document.getElementById('customTitle');
        const titleTimeZone = document.getElementById('weatherTimeZone');
        const titleTimeZoneLabel = document.querySelector('label[for="weatherTimeZone"]');
        const apiKeyLabel = document.querySelector('.api-key-label');

        if (provider === 'OpenMeteo') {
            // Hide or disable "Location" radio option
            titleLocationRadio.style.display = 'none';
            titleLocationLabel.style.display = 'none';
            titleLocationRadio.disabled = true;
            titleTimeZone.style.display = 'none';
            titleTimeZoneLabel.style.display = 'none';
            titleTimeZone.disabled = true;

            // Allow "None" or "Custom"
            titleNoneRadio.disabled = false;
            titleCustomRadio.disabled = false;
            if (titleLocationRadio.checked) {
                titleNoneRadio.checked = true;
            }

            // Hide API Key required label for Open-Meteo
            if (apiKeyLabel) apiKeyLabel.style.display = 'none';
        } else {
            // Show and enable both options
            titleLocationRadio.style.display = '';
            titleLocationLabel.style.display = '';
            titleLocationRadio.disabled = false;
            titleNoneRadio.style.display = '';
            titleNoneLabel.style.display = '';
            titleNoneRadio.disabled = false;

            titleCustomRadio.disabled = false;

            titleTimeZone.style.display = '';
            titleTimeZoneLabel.style.display = '';
            titleTimeZone.disabled = false;

            // Show API Key required label for OpenWeatherMap
            if (apiKeyLabel) apiKeyLabel.style.display = '';
        }
        updateTitleInputState();
    }

    function updateTitleInputState() {
        const selection = document.querySelector('input[name="titleSelection"]:checked')?.value;
        const customTitleInput = document.getElementById('customTitle');
        if (customTitleInput) {
            customTitleInput.disabled = selection !== 'custom';
        }
    }

    function toggleMetricOptions(isEnabled) {
        const metricToggleIds = [
            'displayMetricSunrise',
            'displayMetricSunset',
            'displayMetricWind',
            'displayMetricHumidity',
            'displayMetricPressure',
            'displayMetricUvIndex',
            'displayMetricVisibility',
            'displayMetricAirQuality'
        ];
        metricToggleIds.forEach((id) => {
            const checkbox = document.getElementById(id);
            if (!checkbox) return;
            checkbox.disabled = !isEnabled;
        });
    }

    const SETTINGS_COOKIE_NAME = 'weatherSettingsCache';
    const SETTINGS_COOKIE_MAX_AGE = 60 * 60 * 24 * 30;

    function setCookie(name, value, maxAgeSeconds) {
        document.cookie = `${name}=${encodeURIComponent(value)}; max-age=${maxAgeSeconds}; path=/`;
    }

    function getCookie(name) {
        const prefix = `${name}=`;
        const cookie = document.cookie
            .split('; ')
            .find((row) => row.startsWith(prefix));
        return cookie ? cookie.substring(prefix.length) : '';
    }

    function readCachedSettings() {
        const raw = getCookie(SETTINGS_COOKIE_NAME);
        if (!raw) return null;
        try {
            return JSON.parse(decodeURIComponent(raw));
        } catch (error) {
            return null;
        }
    }

    function setCheckbox(id, value) {
        const checkbox = document.getElementById(id);
        if (!checkbox) return;
        const checked = value === true || value === "true";
        checkbox.checked = checked;
        checkbox.value = checked ? "true" : "false";
    }

    function collectWeatherSettings() {
        const titleSelection = document.querySelector('input[name="titleSelection"]:checked')?.value;
        return {
            latitude: document.getElementById('latitude')?.value ?? '',
            longitude: document.getElementById('longitude')?.value ?? '',
            weatherProvider: document.getElementById('weatherProvider')?.value ?? 'OpenMeteo',
            units: document.getElementById('units')?.value ?? 'imperial',
            titleSelection: titleSelection ?? 'location',
            customTitle: document.getElementById('customTitle')?.value ?? '',
            displayRefreshTime: document.getElementById('displayRefreshTime')?.checked ?? true,
            displayMetricIcons: document.getElementById('displayMetricIcons')?.checked ?? true,
            displayForecastIcons: document.getElementById('displayForecastIcons')?.checked ?? true,
            displayGraph: document.getElementById('displayGraph')?.checked ?? true,
            displayRain: document.getElementById('displayRain')?.checked ?? false,
            displayMetrics: document.getElementById('displayMetrics')?.checked ?? true,
            displayMetricSunrise: document.getElementById('displayMetricSunrise')?.checked ?? true,
            displayMetricSunset: document.getElementById('displayMetricSunset')?.checked ?? true,
            displayMetricWind: document.getElementById('displayMetricWind')?.checked ?? true,
            displayMetricHumidity: document.getElementById('displayMetricHumidity')?.checked ?? true,
            displayMetricPressure: document.getElementById('displayMetricPressure')?.checked ?? true,
            displayMetricUvIndex: document.getElementById('displayMetricUvIndex')?.checked ?? true,
            displayMetricVisibility: document.getElementById('displayMetricVisibility')?.checked ?? true,
            displayMetricAirQuality: document.getElementById('displayMetricAirQuality')?.checked ?? true,
            displayForecast: document.getElementById('displayForecast')?.checked ?? true,
            forecastDays: document.getElementById('forecastDays')?.value ?? '7',
            displayForecastPrecip: document.getElementById('displayForecastPrecip')?.checked ?? false,
            moonPhase: document.getElementById('moonPhase')?.checked ?? false,
            weatherTimeZone: document.getElementById('weatherTimeZone')?.value ?? 'locationTimeZone',
            use24hTime: document.getElementById('use24hTime')?.checked ?? false
        };
    }

    function saveCachedSettings() {
        const settings = collectWeatherSettings();
        setCookie(SETTINGS_COOKIE_NAME, JSON.stringify(settings), SETTINGS_COOKIE_MAX_AGE);
    }

    function applyCachedSettings(settings) {
        if (!settings) return;
        if (settings.latitude !== undefined) document.getElementById('latitude').value = settings.latitude;
        if (settings.longitude !== undefined) document.getElementById('longitude').value = settings.longitude;
        if (settings.weatherProvider) document.getElementById('weatherProvider').value = settings.weatherProvider;
        if (settings.units) document.getElementById('units').value = settings.units;
        if (settings.titleSelection) {
            const radio = document.querySelector(`input[name="titleSelection"][value="${settings.titleSelection}"]`);
            if (radio) radio.checked = true;
        }
        if (settings.customTitle !== undefined) document.getElementById('customTitle').value = settings.customTitle;
        setCheckbox('displayRefreshTime', settings.displayRefreshTime);
        setCheckbox('displayMetricIcons', settings.displayMetricIcons);
        setCheckbox('displayForecastIcons', settings.displayForecastIcons);
        setCheckbox('displayGraph', settings.displayGraph);
        setCheckbox('displayRain', settings.displayRain);
        setCheckbox('displayMetrics', settings.displayMetrics);
        setCheckbox('displayMetricSunrise', settings.displayMetricSunrise);
        setCheckbox('displayMetricSunset', settings.displayMetricSunset);
        setCheckbox('displayMetricWind', settings.displayMetricWind);
        setCheckbox('displayMetricHumidity', settings.displayMetricHumidity);
        setCheckbox('displayMetricPressure', settings.displayMetricPressure);
        setCheckbox('displayMetricUvIndex', settings.displayMetricUvIndex);
        setCheckbox('displayMetricVisibility', settings.displayMetricVisibility);
        setCheckbox('displayMetricAirQuality', settings.displayMetricAirQuality);
        setCheckbox('displayForecast', settings.displayForecast);
        setCheckbox('displayForecastPrecip', settings.displayForecastPrecip);
        setCheckbox('moonPhase', settings.moonPhase);
        if (settings.forecastDays) document.getElementById('forecastDays').value = settings.forecastDays;
        if (settings.weatherTimeZone) document.getElementById('weatherTimeZone').value = settings.weatherTimeZone;
        setCheckbox('use24hTime', settings.use24hTime);
    }

    document.addEventListener('DOMContentLoaded', () => {

        const OSM_TILE_URL = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        const $latitude = document.querySelector('#latitude');
        const $longitude = document.querySelector('#longitude');
        const $openMap = document.querySelector('#openMap');
        const $mapModal = document.querySelector('#mapModal');
        const $closeMap = document.querySelector('#closeMap');

        let latitude = +$latitude.value;
        let longitude = +$longitude.value;
        let zoom = latitude && longitude ? 4.5 : 2.5;
        let selectedTitle = 'location';
        let weatherProvider = 'OpenMeteo';
        const weatherDefaults = deviceSettings.weather_defaults || {};
        const metricDefaults = {
            displayMetricSunrise: true,
            displayMetricSunset: true,
            displayMetricWind: true,
            displayMetricHumidity: true,
            displayMetricPressure: true,
            displayMetricUvIndex: true,
            displayMetricVisibility: true,
            displayMetricAirQuality: true
        };
        const applyMetricSettings = (usePluginSettings) => {
            Object.entries(metricDefaults).forEach(([key, defaultValue]) => {
                const rawValue = usePluginSettings && key in pluginSettings ? pluginSettings[key] : defaultValue;
                const checked = rawValue === true || rawValue === "true";
                const checkbox = document.getElementById(key);
                if (checkbox) {
                    checkbox.checked = checked;
                    checkbox.value = checked ? "true" : "false";
                }
            });
        };

        let map, marker;

        $openMap.addEventListener('click', () => {
            openModal('mapModal')
            setTimeout(() => {
                if (!map) {
                    latitude = +$latitude.value;
                    longitude = +$longitude.value;
                    zoom = latitude && longitude ? 4.5 : 2.5;
                    map = L.map('map').setView([latitude, longitude], zoom);
                    L.tileLayer(OSM_TILE_URL).addTo(map);
                    marker = L.marker([latitude, longitude], { draggable: true }).addTo(map);

                    map.on('click', event => {
                        marker.setLatLng(event.latlng);
                    });
                }
            }, 100);
        });

        $closeMap.addEventListener('click', () => {
            const position = marker.getLatLng().wrap();
            $latitude.value = position.lat;
            $longitude.value = position.lng;
            closeModal('mapModal');
            saveCachedSettings();
        });

        if (loadPluginSettings) {
            document.getElementById('latitude').value = pluginSettings.latitude ?? weatherDefaults.latitude ?? '';
            document.getElementById('longitude').value = pluginSettings.longitude ?? weatherDefaults.longitude ?? '';

            document.getElementById('units').value = pluginSettings.units;

            document.getElementById('displayRefreshTime').checked = pluginSettings.displayRefreshTime;
            document.getElementById('displayRefreshTime').value = pluginSettings.displayRefreshTime;

            const legacyIconsValue = pluginSettings.displayIcons;
            const displayMetricIconsValue = pluginSettings.displayMetricIcons ?? legacyIconsValue ?? "true";
            const displayMetricIconsChecked = displayMetricIconsValue === true || displayMetricIconsValue === "true";
            document.getElementById('displayMetricIcons').checked = displayMetricIconsChecked;
            document.getElementById('displayMetricIcons').value = displayMetricIconsChecked ? "true" : "false";

            const displayForecastIconsValue = pluginSettings.displayForecastIcons ?? legacyIconsValue ?? "true";
            const displayForecastIconsChecked = displayForecastIconsValue === true || displayForecastIconsValue === "true";
            document.getElementById('displayForecastIcons').checked = displayForecastIconsChecked;
            document.getElementById('displayForecastIcons').value = displayForecastIconsChecked ? "true" : "false";

            document.getElementById('displayMetrics').checked = pluginSettings.displayMetrics;
            document.getElementById('displayMetrics').value = pluginSettings.displayMetrics;

            document.getElementById('displayGraph').checked = pluginSettings.displayGraph;
            document.getElementById('displayGraph').value = pluginSettings.displayGraph;

			document.getElementById('displayRain').checked = pluginSettings.displayRain;
            document.getElementById('displayRain').value = pluginSettings.displayRain;
			
            document.getElementById('displayForecast').checked = pluginSettings.displayForecast;
            document.getElementById('displayForecast').value = pluginSettings.displayForecast;

            document.getElementById('forecastDays').value = pluginSettings.forecastDays;

            const displayForecastPrecipValue = pluginSettings.displayForecastPrecip ?? "false";
            const displayForecastPrecipChecked = displayForecastPrecipValue === true || displayForecastPrecipValue === "true";
            document.getElementById('displayForecastPrecip').checked = displayForecastPrecipChecked;
            document.getElementById('displayForecastPrecip').value = displayForecastPrecipChecked ? "true" : "false";

            document.getElementById('moonPhase').checked = pluginSettings.moonPhase;
            document.getElementById('moonPhase').value = pluginSettings.moonPhase;

            document.getElementById('weatherTimeZone').value = pluginSettings.weatherTimeZone;
            const use24hTimeValue = pluginSettings.use24hTime ?? "false";
            const use24hTimeChecked = use24hTimeValue === true || use24hTimeValue === "true";
            document.getElementById('use24hTime').checked = use24hTimeChecked;
            document.getElementById('use24hTime').value = use24hTimeChecked ? "true" : "false";

            applyMetricSettings(true);
            
            selectedTitle = pluginSettings.titleSelection ?? weatherDefaults.titleSelection ?? 'location';
            weatherProvider = pluginSettings.weatherProvider || 'OpenMeteo';

            document.getElementById('customTitle').value = pluginSettings.customTitle ?? weatherDefaults.customTitle ?? '';
        } else {
            // set default values
            document.getElementById('units').value = "imperial";
            document.getElementById('displayRefreshTime').checked = true;
            document.getElementById('displayRefreshTime').value = "true";
            document.getElementById('displayMetricIcons').checked = true;
            document.getElementById('displayMetricIcons').value = "true";
            document.getElementById('displayForecastIcons').checked = true;
            document.getElementById('displayForecastIcons').value = "true";
            document.getElementById('displayMetrics').checked = true;
            document.getElementById('displayMetrics').value = "true";
            document.getElementById('displayGraph').checked = true;
            document.getElementById('displayGraph').value = "true";
			document.getElementById('displayRain').checked = false;
            document.getElementById('displayRain').value = "false";
            document.getElementById('displayForecast').checked = true;
            document.getElementById('displayForecast').value = "true";
            document.getElementById('forecastDays').value = 7;
            document.getElementById('displayForecastPrecip').checked = false;
            document.getElementById('displayForecastPrecip').value = "false";
            document.getElementById('moonPhase').checked = false;
            document.getElementById('weatherTimeZone').value = "locationTimeZone";
            document.getElementById('use24hTime').checked = false;
            document.getElementById('use24hTime').value = "false";
            if (weatherDefaults.latitude !== undefined) {
                document.getElementById('latitude').value = weatherDefaults.latitude;
            }
            if (weatherDefaults.longitude !== undefined) {
                document.getElementById('longitude').value = weatherDefaults.longitude;
            }
            if (weatherDefaults.titleSelection) {
                selectedTitle = weatherDefaults.titleSelection;
            }
            if (weatherDefaults.customTitle) {
                document.getElementById('customTitle').value = weatherDefaults.customTitle;
            }
            applyMetricSettings(false);
        }

        const cachedSettings = !loadPluginSettings ? readCachedSettings() : null;
        if (cachedSettings) {
            applyCachedSettings(cachedSettings);
            selectedTitle = cachedSettings.titleSelection ?? selectedTitle;
            weatherProvider = cachedSettings.weatherProvider ?? weatherProvider;
        }

        document.getElementById('weatherProvider').value = weatherProvider;
        document.querySelector(`input[name="titleSelection"][value="${selectedTitle}"]`).checked = true;
        document.querySelectorAll('input[name="titleSelection"]').forEach((radio) => {
            radio.addEventListener('change', () => {
                updateTitleInputState();
                saveCachedSettings();
            });
        });
        updateTitleOptions(weatherProvider)
        toggleMetricOptions(document.getElementById('displayMetrics').checked);
        updateTitleInputState();

        const cacheFields = [
            'weatherProvider',
            'units',
            'customTitle',
            'displayRefreshTime',
            'displayMetricIcons',
            'displayForecastIcons',
            'displayGraph',
            'displayRain',
            'displayMetrics',
            'displayMetricSunrise',
            'displayMetricSunset',
            'displayMetricWind',
            'displayMetricHumidity',
            'displayMetricPressure',
            'displayMetricUvIndex',
            'displayMetricVisibility',
            'displayMetricAirQuality',
            'displayForecast',
            'forecastDays',
            'displayForecastPrecip',
            'moonPhase',
            'weatherTimeZone',
            'use24hTime'
        ];
        cacheFields.forEach((id) => {
            const element = document.getElementById(id);
            if (!element) return;
            element.addEventListener('change', saveCachedSettings);
        });
        const customTitleInput = document.getElementById('customTitle');
        if (customTitleInput) {
            customTitleInput.addEventListener('input', saveCachedSettings);
        }
    });
</script>
